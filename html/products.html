<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Page</title>
    <link rel="stylesheet" type="text/css" href="../css/admin_stylesheet.css">

    <script>
        function home() {
            window.location.href = 'admin.html';
        }

        function maap() {
            window.location.href = 'map.html';
        }

        function products() {
            window.location.href = 'products.html';
        }

        function announcement() {
            window.location.href = 'admin_announcement.html';
        }

        function users() {
            window.location.href = 'users.html';
        }
        
        function chart() {
            window.location.href = 'chart.html';
        }
        document.addEventListener("DOMContentLoaded", function () {
            checkLoginStatus(); 
            fetchCategories();
            fetchExistingItems(); 
            addEnterKeyListener();
        });
        function checkLoginStatus() {
            fetch('../php/check_login.php', {
                method: 'GET',
                credentials: 'include' // Ensures session cookies are sent
            })
            .then(response => response.json())
            .then(data => {
                if (!data.loggedIn) {
                    // Redirect to the login page if not logged in
                    window.location.href = 'login.html';
                } else {
                    // If logged in, fetch categories and items
                    fetchCategories();
                    fetchExistingItems(); 
                    addEnterKeyListener();
                }
            })
            .catch(error => {
                console.error('Error checking login status:', error);
                window.location.href = 'login.html'; // Redirect in case of error
            });
        }

        function logout() {
            fetch('../php/logout.php', {
                method: 'GET',
                credentials: 'include' // Include session cookies
            }).then(response => {
                if (response.ok) {
                    sessionStorage.clear();
                    localStorage.clear();
                    window.location.href = 'login.html';
                } else {
                    console.error('Logout failed');
                }
            }).catch(error => {
                console.error('Error during logout:', error);
            });
        }

        function fetchCategories() {
fetch('http://localhost/final_web/php/get_categories.php')
    .then(response => response.json())
    .then(data => {
        if (data.categories) {
            populateCategoryCheckboxes(data.categories);
        } else {
            console.error('No categories found:', data);
        }
    })
    .catch(error => {
        console.error('Error fetching categories:', error);
    });
}
// js sinartisi gia na kanw populate tis katigories
function populateCategoryCheckboxes(categories) {
const checkboxContainer = document.getElementById('categoryCheckboxes');
checkboxContainer.innerHTML = ''; // Clear previous checkboxes

categories.forEach(category => {
    const label = document.createElement('label');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = category.cat_name;
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(category.cat_name));
    checkboxContainer.appendChild(label);
    checkboxContainer.appendChild(document.createElement('br')); 
});
}
function fetchExistingItems() {
const selectedCategories = Array.from(document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
const onlyAvailable = document.getElementById('availabilityCheckbox').checked;

const queryParams = new URLSearchParams({
    categories: JSON.stringify(selectedCategories), 
    only_available: onlyAvailable
}).toString();

fetch(`http://localhost/final_web/php/get_items.php?${queryParams}`)
    .then(response => response.json())
    .then(data => {
        if (data.items) {
            displayItems(data.items);
        } else {
            console.error('No items found:', data);
        }
    })
    .catch(error => {
        console.error('Error fetching items:', error);
    });
}


        function applyFilters() {
            fetchExistingItems(); 
        }

        function displayItems(items) {
            const itemsTable = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
            itemsTable.innerHTML = '';

            if (items && Array.isArray(items)) {
                items.forEach(item => {
                    const row = itemsTable.insertRow();
                    const idCell = row.insertCell(0);
                    const nameCell = row.insertCell(1);
                    const categoryCell = row.insertCell(2);
                    const quantityCell = row.insertCell(3);

                    idCell.innerHTML = `<input type="hidden" name="item_id[]" value="${item.item_id}">${item.item_id}`;
                    nameCell.textContent = item.item_name;
                    categoryCell.textContent = item.category_name;
                    quantityCell.innerHTML = `<input type="number" name="quantity[]" value="${item.quantity}">`;
                });

              
                addEnterKeyListener();
            } else {
                console.error('Items is undefined or not an array:', items);
            }
        }

        function addEnterKeyListener() {
          
            const inputs = document.querySelectorAll('#itemsTable input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('keydown', function (event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        saveChanges(); 
                        window.location.reload(); 
                    }
                });
            });
        }

        function saveChanges() {
            const formData = new FormData(document.getElementById('itemsForm'));

            const object = {};
            formData.forEach((value, key) => {
                if (!object[key]) {
                    object[key] = [];
                }
                object[key].push(value);
            });

            const cleanedData = {
                item_id: [],
                quantity: []
            };

            object['item_id[]'].forEach((itemId, index) => {
                const quantity = object['quantity[]'][index];

                if (itemId && !isNaN(quantity) && quantity.trim() !== '') {
                    cleanedData.item_id.push(itemId);
                    cleanedData.quantity.push(quantity);
                }
            });

            console.log('Cleaned FormData:', cleanedData);

            const cleanedFormData = new FormData();
            cleanedData.item_id.forEach((id, index) => {
                cleanedFormData.append('item_id[]', id);
                cleanedFormData.append('quantity[]', cleanedData.quantity[index]);
            });

            fetch('http://localhost/final_web/php/update_items.php', {
                method: 'POST',
                body: cleanedFormData,
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Network response was not ok: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Changes saved successfully!');
                        fetchExistingItems(); 
                    } else {
                        alert('Error saving changes: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
        }

        function refreshInventory() {
            fetch('http://localhost/final_web/php/load_items.php')
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Network response was not ok: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.message) {
                        showMessage(data.message);
                    } else if (data.error) {
                        showMessage(data.error);
                    } else {
                        displayItems(data.items);
                        showMessage('Inventory refreshed successfully!');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing inventory:', error);
                    showMessage('Error refreshing inventory. Please try again.');
                });
        }

        function handleFileUpload() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];

            if (file) {
                const formData = new FormData();
                formData.append('jsonFile', file);

                fetch('/php/upload_json.php', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`Network response was not ok: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.message) {
                            showMessage(data.message);
                        } else if (data.error) {
                            showMessage(data.error);
                        } else {
                            showMessage('JSON file uploaded successfully!');
                        }
                    })
                    .catch(error => {
                        console.error('Error uploading JSON file:', error);
                        showMessage('Error uploading JSON file. Please try again.');
                    });
            } else {
                showMessage('Invalid file upload or missing file.');
           

            }
        }

        function showMessage(message) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.textContent = message;

            setTimeout(() => {
                messageContainer.textContent = '';
            }, 3000);
        }

        function home() {
        window.location.href = 'admin.html';
    }

    function map() {
        window.location.href = 'map.html';
    }


    function products() {
        window.location.href = 'products.html';
    }

    function announcement() {
        window.location.href = 'admin_announcement.html';
    }

    function users() {
        window.location.href = 'users.html';
    }

    </script>
</head>

<body>
    <header>
        <h1>Admin Dashboard</h1>
    </header>
    <nav>
        <a href="#" onclick="home()">Home</a>
        <a href="#" onclick="users()">Users</a>
        <a href="#" onclick="products()">Products</a>
        <a href="#" onclick="announcement()">Announcements</a>
        <a href="#" onclick="map()">Map</a>
        <a href="#" onclick="chart()">Chart</a>
    </nav>
    <section>
        <h2 id="top">Available Items</h2>

        
        <div id="filters">
            <label>Category:</label>
            <div id="categoryCheckboxes">
                <!-- Edw tha mpoun oi katigories -->
            </div>
        
            <label for="availabilityCheckbox">
                <input type="checkbox" id="availabilityCheckbox">
                Only Available
            </label>
        
            <button type="button" onclick="applyFilters()">Apply Filters</button>
        </div>

        <div class="table-container">
            <form id="itemsForm">
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th>Item ID</th>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Edw mpainoun ta rows -->
                    </tbody>
                </table>
                <button type="button" onclick="saveChanges()">Save Changes</button>
            </form>
        </div>

        <div id="result"></div>

        <div id="messageContainer"></div>

        <!-- forma gia to json -->
        <form id="uploadForm" enctype="multipart/form-data">
            <label for="jsonFileInput">Update your database by choosing a JSON file:</label>
            <input type="file" name="jsonFile" id="jsonFileInput" accept=".json">
            <br>
            <input type="button" value="Upload JSON" onclick="handleFileUpload()">
        </form>

        <br><br><br>

        <!-- Refresh Inventory button -->
         <div> Press "Refresh Inventory" to automatically refresh your storage.</div>
        <button onclick="refreshInventory()">Refresh Inventory</button>

      
    </section>
</body>

<footer>
    &copy; 2024 Admin Dashboard <br><br><br>
    <button onclick="logout()">Log Out</button>
</footer>

</html>