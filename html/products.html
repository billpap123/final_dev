<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Page</title>
    <link rel="stylesheet" type="text/css" href="../css/prod_stylesheet.css">
</head>

<body>
    <nav>
        <a href="#" onclick="home()">Home</a>
        <a href="#" onclick="users()">Users</a>
        <a href="#" onclick="products()">Products</a>
        <a href="#" onclick="settings()">Settings</a>
        <a href="#" onclick="posts()">Posts</a>
        <a href="#" onclick="map()">Map</a>
    </nav>

    <section>
        <h2 id="top">Available Items</h2>

        <!-- Filter Options -->
        <div id="filters">
            <label>Category:</label>
            <div id="categoryCheckboxes">
                <!-- Category checkboxes will be populated here -->
            </div>
        
            <label for="availabilityCheckbox">
                <input type="checkbox" id="availabilityCheckbox">
                Only Available
            </label>
        
            <button type="button" onclick="applyFilters()">Apply Filters</button>
        </div>

        <div class="table-container">
            <form id="itemsForm">
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th>Item ID</th>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically inserted here -->
                    </tbody>
                </table>
                <button type="button" onclick="saveChanges()">Save Changes</button>
            </form>
        </div>

        <!-- Display result -->
        <div id="result"></div>

        <!-- Message container -->
        <div id="messageContainer"></div>

        <!-- Form for uploading JSON file -->
        <form id="uploadForm" enctype="multipart/form-data">
            <label for="jsonFileInput">Choose a JSON file:</label>
            <input type="file" name="jsonFile" id="jsonFileInput" accept=".json">
            <br>
            <input type="button" value="Upload JSON" onclick="handleFileUpload()">
        </form>

        <br><br><br>

        <!-- Refresh Inventory button -->
        <button onclick="refreshInventory()">Refresh Inventory</button>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                fetchCategories();
                fetchExistingItems(); // Initial load of items
                addEnterKeyListener();
            });

            function fetchCategories() {
    fetch('http://localhost/final_web/php/get_categories.php')
        .then(response => response.json())
        .then(data => {
            if (data.categories) {
                populateCategoryCheckboxes(data.categories);
            } else {
                console.error('No categories found:', data);
            }
        })
        .catch(error => {
            console.error('Error fetching categories:', error);
        });
}

function populateCategoryCheckboxes(categories) {
    const checkboxContainer = document.getElementById('categoryCheckboxes');
    checkboxContainer.innerHTML = ''; // Clear previous checkboxes

    categories.forEach(category => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = category.cat_name;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(category.cat_name));
        checkboxContainer.appendChild(label);
        checkboxContainer.appendChild(document.createElement('br')); // Line break for better readability
    });
}
function fetchExistingItems() {
    const selectedCategories = Array.from(document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
    const onlyAvailable = document.getElementById('availabilityCheckbox').checked;

    const queryParams = new URLSearchParams({
        categories: JSON.stringify(selectedCategories), // Properly encode the array as JSON
        only_available: onlyAvailable
    }).toString();

    fetch(`http://localhost/final_web/php/get_items.php?${queryParams}`)
        .then(response => response.json())
        .then(data => {
            if (data.items) {
                displayItems(data.items);
            } else {
                console.error('No items found:', data);
            }
        })
        .catch(error => {
            console.error('Error fetching items:', error);
        });
}


            function applyFilters() {
                fetchExistingItems(); // Refetch items with applied filters
            }

            function displayItems(items) {
                const itemsTable = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
                itemsTable.innerHTML = '';

                if (items && Array.isArray(items)) {
                    items.forEach(item => {
                        const row = itemsTable.insertRow();
                        const idCell = row.insertCell(0);
                        const nameCell = row.insertCell(1);
                        const categoryCell = row.insertCell(2);
                        const quantityCell = row.insertCell(3);

                        idCell.innerHTML = `<input type="hidden" name="item_id[]" value="${item.item_id}">${item.item_id}`;
                        nameCell.textContent = item.item_name;
                        categoryCell.textContent = item.category_name;
                        quantityCell.innerHTML = `<input type="number" name="quantity[]" value="${item.quantity}">`;
                    });

                    // Re-apply Enter key listener to newly added input fields
                    addEnterKeyListener();
                } else {
                    console.error('Items is undefined or not an array:', items);
                }
            }

            function addEnterKeyListener() {
                // Add keydown event listener to input fields in the table
                const inputs = document.querySelectorAll('#itemsTable input[type="number"]');
                inputs.forEach(input => {
                    input.addEventListener('keydown', function (event) {
                        if (event.key === 'Enter') {
                            event.preventDefault(); // Prevent the default form submission
                            saveChanges(); // Save the changes
                            window.location.reload(); // Refresh the page after saving
                        }
                    });
                });
            }

            function saveChanges() {
                const formData = new FormData(document.getElementById('itemsForm'));

                const object = {};
                formData.forEach((value, key) => {
                    if (!object[key]) {
                        object[key] = [];
                    }
                    object[key].push(value);
                });

                const cleanedData = {
                    item_id: [],
                    quantity: []
                };

                object['item_id[]'].forEach((itemId, index) => {
                    const quantity = object['quantity[]'][index];

                    if (itemId && !isNaN(quantity) && quantity.trim() !== '') {
                        cleanedData.item_id.push(itemId);
                        cleanedData.quantity.push(quantity);
                    }
                });

                console.log('Cleaned FormData:', cleanedData);

                const cleanedFormData = new FormData();
                cleanedData.item_id.forEach((id, index) => {
                    cleanedFormData.append('item_id[]', id);
                    cleanedFormData.append('quantity[]', cleanedData.quantity[index]);
                });

                fetch('http://localhost/final_web/php/update_items.php', {
                    method: 'POST',
                    body: cleanedFormData,
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`Network response was not ok: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            alert('Changes saved successfully!');
                            fetchExistingItems(); // Refresh the table after saving changes
                        } else {
                            alert('Error saving changes: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    });
            }

            function refreshInventory() {
                fetch('http://localhost/final_web/php/load_items.php')
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`Network response was not ok: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.message) {
                            showMessage(data.message);
                        } else if (data.error) {
                            showMessage(data.error);
                        } else {
                            displayItems(data.items);
                            showMessage('Inventory refreshed successfully!');
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing inventory:', error);
                        showMessage('Error refreshing inventory. Please try again.');
                    });
            }

            function handleFileUpload() {
                const fileInput = document.getElementById('jsonFileInput');
                const file = fileInput.files[0];

                if (file) {
                    const formData = new FormData();
                    formData.append('jsonFile', file);

                    fetch('/php/upload_json.php', {
                        method: 'POST',
                        body: formData,
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(text => {
                                    throw new Error(`Network response was not ok: ${text}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.message) {
                                showMessage(data.message);
                            } else if (data.error) {
                                showMessage(data.error);
                            } else {
                                showMessage('JSON file uploaded successfully!');
                            }
                        })
                        .catch(error => {
                            console.error('Error uploading JSON file:', error);
                            showMessage('Error uploading JSON file. Please try again.');
                        });
                } else {
                    showMessage('Invalid file upload or missing file.');
               

                }
            }

            function showMessage(message) {
                const messageContainer = document.getElementById('messageContainer');
                messageContainer.textContent = message;

                setTimeout(() => {
                    messageContainer.textContent = '';
                }, 3000);
            }
        </script>
    </section>
</body>

</html>